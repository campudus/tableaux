# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-gradle

name: Java CI with Gradle

on:
  # push:
  #   branches: [ master ]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        postgres-version:
          - 9.6
        postgres-db:
          - github_ci_test
        postgres-pw:
          - postgres
        postgres-user:
          - postgres
        postgres-host:
          - 127.0.0.1
        postgres-port:
          - 5432
      # uncomment when we activate matrix
      # max-parallel: 4

    services:
      postgres:
        image: postgres:${{ matrix.postgres-version }}
        env:
          POSTGRES_DB: ${{ matrix.postgres-db }}
          POSTGRES_USER: ${{ matrix.postgres-user }}
          POSTGRES_PASSWORD: ${{ matrix.postgres-pw }}
        ports:
          - 5432:5432
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v2

      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: "1.8"

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install --yes postgresql-client

      # test queries database with postgres client
      - name: Query database
        run: psql -h ${{ matrix.postgres-host }} -d ${{ matrix.postgres-db }} -U ${{ matrix.postgres-user }} -c 'SELECT VERSION();'
        env:
          # postgress password is required; alternatively, you can run:
          # `PGPASSWORD=postgres_password psql ...`
          PGPASSWORD: ${{ matrix.postgres-pw }}

      # - name: Cleanup
      #   uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
      #   with:
      #     arguments: clean

      # - name: Assemble test classes
      #   uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
      #   with:
      #     arguments: testClasses

      # - name: Assemble
      #   uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
      #   with:
      #     arguments: assemble

      # - name: Spotless Check
      #   uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
      #   with:
      #     arguments: spotlessCheck scoverageClasses --info --stacktrace

      # - name: Test
      #   uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
      #   with:
      #     arguments: test -Pconf='github_ci_test.json' --tests="com.campudus.tableaux.helper.FileUtilsTest.testLoadNonExistingJsonFileShouldFail" --info --stacktrace
